<ng-container *ngIf="user$ | ngrxPush as user">
  <cvc-section-navigation [displayName]="user.displayName">
  </cvc-section-navigation>

  <nz-page-header class="site-page-header">
    <nz-page-header-content>
      <nz-row
        [nzGutter]="[8, 8]"
        class="profile-content">
        <!-- avatar column -->
        <nz-col nzFlex="0 1 128px">
          <nz-space nzDirection="vertical">
            <cvc-user-avatar
              [user]="user"
              shape="square"
              [size]="128"
              *nzSpaceItem></cvc-user-avatar>
            <div
              class="user-pseudo-tag"
              *nzSpaceItem>
              <i
                nz-icon
                [nzType]="'civic-' + (user.role | lowercase)"
                nzTheme="twotone"
                [nzTwotoneColor]="user.role | titlecase | entityColor"></i>
              <span nz-typography>
                <strong> {{ user.username }}</strong>
              </span>
            </div>
            <div *nzSpaceItem>
              <nz-descriptions
                nzLayout="vertical"
                nzSize="small"
                [nzBordered]="true"
                [nzColumn]="1">
                <!-- username -->
                <nz-descriptions-item
                  *ngIf="user.name"
                  nzTitle="Name">
                  {{ user.name }}
                </nz-descriptions-item>

                <!-- role -->
                <nz-descriptions-item nzTitle="Role">
                  {{ user.role | enumToTitle }}
                </nz-descriptions-item>
              </nz-descriptions>
            </div>
            <ng-container *ngIf="this.ownProfile$ | ngrxPush">
              <button
                *nzSpaceItem
                nz-button
                nzSize="small"
                nzType="primary"
                nzBlock
                (click)="updateProfileModalVisible = true">
                Edit Profile
              </button>
              <cvc-avatar-uploader
                *nzSpaceItem
                (uploadComplete)="profileUploadComplete($event)">
              </cvc-avatar-uploader>
            </ng-container>
          </nz-space>
        </nz-col>

        <!-- bio, organizations, COI column -->
        <nz-col nzFlex="1 1 400px">
          <nz-space
            nzDirection="vertical"
            style="width: 100%">
            <nz-descriptions
              nzLayout="vertical"
              nzSize="small"
              nzBordered="true"
              [nzColumn]="4"
              *nzSpaceItem>
              <nz-descriptions-item
                nzTitle="Biography"
                nzSpan="4">
                <ng-container *ngIf="user.bio">
                  {{ user.bio }}
                </ng-container>
                <ng-container *ngIf="!user.bio">
                  <span
                    nz-typography
                    nzType="secondary">
                    <i>User has not provided a bio.</i>
                  </span>
                </ng-container>
              </nz-descriptions-item>

              <nz-descriptions-item
                [nzSpan]="2"
                nzTitle="Area of Expertise">
                <ng-container *ngIf="user.areaOfExpertise">
                  {{ user.areaOfExpertise | enumToTitle }}
                </ng-container>
                <ng-container *ngIf="!user.areaOfExpertise">
                  <span
                    nz-typography
                    nzType="secondary">
                    <i>Unspecified</i>
                  </span>
                </ng-container>
              </nz-descriptions-item>

              <nz-descriptions-item
                [nzSpan]="2"
                nzTitle="Country">
                <ng-container *ngIf="user.country">
                  {{ user.country.name }}
                </ng-container>
                <ng-container *ngIf="!user.country">
                  <span
                    nz-typography
                    nzType="secondary">
                    <i>Unspecified</i>
                  </span>
                </ng-container>
              </nz-descriptions-item>

              <nz-descriptions-item
                [nzSpan]="4"
                [nzTitle]="
                  'Organization' + (user.organizations.length > 1 ? 's' : '')
                ">
                <ng-container *ngIf="user.organizations.length > 0">
                  <cvc-tag-overflow
                    tagType="organization"
                    [maxDisplayCount]="2"
                    [tags]="organization$ | ngrxPush">
                  </cvc-tag-overflow>
                </ng-container>
                <ng-container *ngIf="user.organizations.length === 0">
                  <span
                    nz-typography
                    nzType="secondary">
                    <i>User is not a member of any Organizations.</i>
                  </span>
                </ng-container>
              </nz-descriptions-item>
            </nz-descriptions>

            <!-- Editor COI card -->
            <ng-container
              *ngIf="user.role === 'EDITOR' || user.role === 'ADMIN'">
              <nz-card
                class="editor-coi-card"
                [nzTitle]="statementTitle"
                nzSize="small"
                [nzExtra]="updateCoi"
                *nzSpaceItem>
                <ng-template #statementTitle>
                  <i
                    nz-icon
                    [nzType]="'civic-' + (user.role | lowercase)"
                    nzTheme="twotone"
                    [nzTwotoneColor]="user.role | titlecase | entityColor"></i>
                  Editor Conflict of Interest Statement
                </ng-template>
                <ng-template #updateCoi>
                  <ng-container *ngIf="this.ownProfile$ | ngrxPush">
                    <button
                      nz-button
                      nzType="primary"
                      nzSize="small"
                      (click)="this.updateCoiModalVisible = true">
                      Update COI
                    </button>
                  </ng-container>
                </ng-template>
                <nz-descriptions
                  [nzBordered]="true"
                  [nzColumn]="3"
                  class="user-coi"
                  nzLayout="horizontal"
                  nzSize="small">
                  <ng-container
                    *ngIf="user.mostRecentConflictOfInterestStatement">
                    <nz-descriptions-item
                      [nzSpan]="1"
                      nzTitle="Status">
                      {{
                        user.mostRecentConflictOfInterestStatement.coiStatus
                          | enumToTitle
                      }}
                    </nz-descriptions-item>
                    <nz-descriptions-item
                      [nzSpan]="1"
                      nzTitle="Updated">
                      {{
                        user.mostRecentConflictOfInterestStatement.createdAt
                          | date : 'shortDate'
                      }}
                    </nz-descriptions-item>
                    <nz-descriptions-item
                      [nzSpan]="1"
                      nzTitle="Expires">
                      {{
                        user.mostRecentConflictOfInterestStatement.expiresAt
                          | date : 'shortDate'
                      }}
                    </nz-descriptions-item>
                    <nz-descriptions-item
                      [nzSpan]="3"
                      nzTitle="Statement">
                      <ng-container
                        *ngIf="
                          user.mostRecentConflictOfInterestStatement.coiPresent;
                          else noStatement
                        ">
                        {{
                          user.mostRecentConflictOfInterestStatement
                            .coiStatement
                        }}
                      </ng-container>
                      <ng-template #noStatement>
                        I do not have any potential conflicts of interest.
                      </ng-template>
                    </nz-descriptions-item>
                  </ng-container>
                  <ng-container
                    *ngIf="!user.mostRecentConflictOfInterestStatement">
                    <nz-descriptions-item
                      [nzSpan]="3"
                      nzTitle="Status"
                      >None on file.</nz-descriptions-item
                    >
                  </ng-container>
                </nz-descriptions>
              </nz-card>
            </ng-container>
          </nz-space>
        </nz-col>

        <!-- stats column -->
        <nz-col nzFlex="0 1 120px">
          <nz-descriptions
            nzSize="small"
            nzLayout="vertical"
            nzBordered="true">
            <nz-descriptions-item nzTitle="Activity">
              <cvc-stats-card
                [stats]="user.statsHash"
                header="User Statistics"></cvc-stats-card>
            </nz-descriptions-item>
          </nz-descriptions>
        </nz-col>
      </nz-row>
      <nz-row style="margin-top: 16px">
        <nz-col nzSpan="24">
          <cvc-tab-navigation [tabs]="tabs$ | ngrxPush"> </cvc-tab-navigation>
          <div class="content">
            <router-outlet></router-outlet>
          </div>
        </nz-col>
      </nz-row>
    </nz-page-header-content>
  </nz-page-header>

  <nz-modal
    [(nzVisible)]="this.updateProfileModalVisible"
    [nzContent]="profileModalContent"
    [nzTitle]="profileModalTitle"
    [nzFooter]="null"
    (nzOnCancel)="this.handleProfileModalCancel()">
    <ng-template #profileModalTitle><span>Edit Profile</span></ng-template>
    <ng-template #profileModalContent>
      <cvc-user-profile-form
        [user]="user"
        (profileUpdatedEvent)="this.profileUpdated()"></cvc-user-profile-form>
    </ng-template>
  </nz-modal>
</ng-container>

<nz-modal
  [(nzVisible)]="this.updateCoiModalVisible"
  [nzContent]="coiModalContent"
  [nzTitle]="coiModalTitle"
  [nzFooter]="null"
  (nzOnCancel)="this.handleCoiModalCancel()">
  <ng-template #coiModalTitle
    ><span>Update your Conflict of Interest Statement</span></ng-template
  >
  <ng-template #coiModalContent>
    <cvc-user-coi-form
      (coiUpdatedEvent)="this.coiUpdated()"></cvc-user-coi-form>
  </ng-template>
</nz-modal>
