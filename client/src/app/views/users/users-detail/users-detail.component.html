<ng-container *ngIf="user$ | ngrxPush as user">
  <cvc-section-navigation [displayName]="user.displayName">
  </cvc-section-navigation>

  <nz-page-header class="site-page-header">
    <!-- title -->
    <nz-page-header-title>
      <i nz-icon
        nzType="civic:user"></i>
      <span routerLink="/user/{{user.id}}">
        {{ user.name }}
      </span>
    </nz-page-header-title>

    <!--extra-->
    <nz-page-header-content>
      <nz-alert *ngIf="this.uploadError"
        nzType="error"
        nzCloseable
        nzMessage="There was an error updating your profile image."
        (nzOnClose)="this.uploadError = false"></nz-alert>
      <nz-alert *ngIf="this.updateSuccess"
        nzType="success"
        nzCloseable
        nzMessage="Profile image successfully updated."
        (nzOnClose)="this.updateSuccess = false"></nz-alert>
      <div class="content">
        <nz-row
          [nzGutter]="16">
          <nz-col
            [nzSpan]="3">
            <nz-space nzDirection="vertical"
              nzSize="middle">
              <cvc-user-avatar [user]="user"
                [size]="128"
                *nzSpaceItem></cvc-user-avatar>
              <ng-container *ngIf="this.ownProfile$ | ngrxPush">
                <cvc-avatar-uploader (uploadComplete)="profileUploadComplete($event)"
                  *nzSpaceItem></cvc-avatar-uploader>
              </ng-container>
            </nz-space>
          </nz-col>
          <nz-col
            [nzSpan]='13'>
            <nz-descriptions nzTitle="Profile"
              nzBordered
              [nzExtra]="updateProfile">

              <nz-descriptions-item [nzSpan]="2"
                nzTitle="Username">
                {{ user.username }}
              </nz-descriptions-item>

              <nz-descriptions-item [nzSpan]="2"
                nzTitle="Role">
                {{user.role | enumToTitle}}
              </nz-descriptions-item>

              <nz-descriptions-item [nzSpan]="4"
                nzTitle="Bio">
                {{user.bio}}
              </nz-descriptions-item>

              <nz-descriptions-item [nzSpan]="2"
                nzTitle="Area of Expertise">
                {{ user.areaOfExpertise | enumToTitle }}
              </nz-descriptions-item>

              <nz-descriptions-item [nzSpan]="2"
                nzTitle="Country">
                {{ user.country?.name }}
              </nz-descriptions-item>

              <nz-descriptions-item *ngIf="user.organizations.length > 0"
                [nzSpan]="4"
                nzTitle="Organizations">
                <cvc-organization-tag *ngFor="let org of user.organizations"
                  [org]="org"></cvc-organization-tag>
              </nz-descriptions-item>

              <ng-template #updateProfile>
                <ng-container *ngIf="this.ownProfile$ | ngrxPush">
                  <button nz-button
                    nzSize="small"
                    (click)="this.updateProfileModalVisible = true">
                    Update Profile <i nz-icon
                      nzType="edit"
                      nzTheme="outline"></i>
                  </button>
                </ng-container>
              </ng-template>

            </nz-descriptions>
          </nz-col>
          <nz-col *ngIf="user.role === 'EDITOR' || user.role === 'ADMIN'"
            [nzSpan]="8">
            <nz-descriptions nzTitle="Editor Conflict of Interest Statement"
              nzBordered
              [nzExtra]="updateCoi">
              <ng-container *ngIf="user.mostRecentConflictOfInterestStatement">
                <nz-descriptions-item [nzSpan]="3"
                  nzTitle="Status">
                  {{ user.mostRecentConflictOfInterestStatement.coiStatus | enumToTitle }}
                </nz-descriptions-item>
                <nz-descriptions-item [nzSpan]="2"
                  nzTitle="Updated">{{user.mostRecentConflictOfInterestStatement.createdAt | date:"shortDate" }} </nz-descriptions-item>
                <nz-descriptions-item [nzSpan]="2"
                  nzTitle="Expires">
                  {{user.mostRecentConflictOfInterestStatement.expiresAt | date:"shortDate" }}
                </nz-descriptions-item>
                <nz-descriptions-item [nzSpan]="3"
                  nzTitle="Statement">
                  <ng-container *ngIf="user.mostRecentConflictOfInterestStatement.coiPresent; else noStatement">
                    {{user.mostRecentConflictOfInterestStatement.coiStatement }}
                  </ng-container>
                  <ng-template #noStatement>
                    I do not have any potential conflicts of interest.
                  </ng-template>
                </nz-descriptions-item>
              </ng-container>
              <ng-container *ngIf="!user.mostRecentConflictOfInterestStatement">
                <nz-descriptions-item [nzSpan]="3"
                  nzTitle="Status">None on file.</nz-descriptions-item>
              </ng-container>
              <ng-template #updateCoi>
                <ng-container *ngIf="this.ownProfile$ | ngrxPush">
                  <button nz-button
                    nzSize="small"
                    (click)="this.updateCoiModalVisible = true">
                    Update COI <i nz-icon
                      nzType="edit"
                      nzTheme="outline"></i>
                  </button>
                </ng-container>
              </ng-template>
            </nz-descriptions>
          </nz-col>
        </nz-row>
        <nz-row>
          <nz-col
            [nzSpan]="24">
            <nz-divider></nz-divider>
            <cvc-stats-card [stats]="user.statsHash"
              header="User Statistics"></cvc-stats-card>
          </nz-col>
        </nz-row>
      </div>
      <cvc-tab-navigation [tabs]="tabs$ | ngrxPush"> </cvc-tab-navigation>
      <router-outlet></router-outlet>
    </nz-page-header-content>
  </nz-page-header>
  <nz-modal [(nzVisible)]="this.updateProfileModalVisible"
    [nzContent]="profileModalContent"
    [nzTitle]="profileModalTitle"
    [nzFooter]="null"
    (nzOnCancel)="this.handleProfileModalCancel()">
    <ng-template #profileModalTitle><span>Update Profile</span></ng-template>
    <ng-template #profileModalContent>
      <cvc-user-profile-form [user]="user"
        (profileUpdatedEvent)="this.profileUpdated()"></cvc-user-profile-form>
    </ng-template>
  </nz-modal>
</ng-container>

<nz-modal [(nzVisible)]="this.updateCoiModalVisible"
  [nzContent]="coiModalContent"
  [nzTitle]="coiModalTitle"
  [nzFooter]="null"
  (nzOnCancel)="this.handleCoiModalCancel()">
  <ng-template #coiModalTitle><span>Update your Conflict of Interest Statement</span></ng-template>
  <ng-template #coiModalContent>
    <cvc-user-coi-form (coiUpdatedEvent)="this.coiUpdated()"></cvc-user-coi-form>
  </ng-template>
</nz-modal>
