<cvc-form-submission-status-display
  [mutationState]="state"
  entityType="Molecular Profile"
  [successMessage]="success">
  <ng-template #success>Added new Molecular Profile</ng-template>
  <!-- info & error messages row -->
  <nz-row
    [nzGutter]="[6, 6]"
    class="info-row">
    <nz-col nzSpan="24">
      <!-- ERROR -->
      <ng-container *ngIf="expressionError$ | ngrxPush as error">
        <nz-alert
          nzType="error"
          [nzMessage]="error.errorMessage"
          [nzAction]="errorAction"
          nzShowIcon></nz-alert>
        <ng-template #errorAction>
          <button
            nz-button
            nzDanger
            nzType="dashed"
            nzSize="small"
            nzShape="round">
            <span
              *ngIf="error.errorHelp as helptext"
              nz-tooltip
              [nzTooltipTitle]="helptext">
              <span
                nz-icon
                nzType="question-circle"
                nzTheme="fill"></span>
              SYNTAX ASSISTANCE
            </span>
          </button>
        </ng-template>
      </ng-container>

      <!-- MESSAGE -->
      <ng-container *ngIf="expressionMessage$ | ngrxPush as message">
        <nz-alert
          nzType="info"
          [nzMessage]="message"
          [nzAction]="messageAction"
          nzShowIcon></nz-alert>

        <ng-template #messageAction>
          <button
            nz-button
            nzType="dashed"
            nzSize="small"
            nzShape="round">
            <span
              nz-tooltip
              [nzTooltipTitle]="
                'Enter #VID[id] and boolean tokens to construct a Molecular Profile expression.'
              ">
              <span
                nz-icon
                nzType="question-circle"
                nzTheme="fill"></span>
              GETTING STARTED
            </span>
          </button>
        </ng-template>
      </ng-container>
      <!-- SUCCESS -->
      <ng-container *ngrxLet="existingMp$ as mp">
        <ng-container
          *ngIf="
            !(expressionError$ | ngrxPush) && !(expressionMessage$ | ngrxPush)
          ">
          <!-- FOUND EXISTING MP -->
          <ng-container *ngIf="mp !== undefined">
            <nz-alert
              nzType="success"
              [nzMessage]="foundMessage"
              [nzAction]="selectAction"
              nzShowIcon></nz-alert>
            <ng-template #selectAction>
              <button
                (click)="cvcOnSelect.next(mp)"
                type="button"
                nz-button
                nzType="primary"
                nzBlock>
                Select this MP
              </button>
            </ng-template>
            <ng-template #foundMessage>
              Molecular Profile <strong>{{ mp.name }}</strong> found.
            </ng-template>
          </ng-container>

          <!-- CREATE NEW MP -->
          <ng-container *ngIf="mp === undefined">
            <nz-alert
              nzType="success"
              [nzMessage]="createMessage"
              [nzAction]="createAction"
              nzShowIcon></nz-alert>
            <ng-template #createAction>
              <button
                (click)="onCreateNewMp$.next()"
                type="button"
                nz-button
                nzType="primary"
                nzBlock>
                Create New MP
              </button>
            </ng-template>
            <ng-template #createMessage>
              Molecular Profile not found, create it?
            </ng-template>
          </ng-container>
        </ng-container>
      </ng-container>
    </nz-col>
  </nz-row>

  <nz-row
    [nzGutter]="[6, 6]"
    class="preview-row">
    <!-- preview row -->
    <nz-col nzSpan="24">
      <div
        class="expression-preview"
        [ngClass]="{ active: (expressionSegment$ | ngrxPush) !== undefined }">
        <ng-container *ngrxLet="expressionSegment$ | ngrxPush as segments">
          <cvc-mp-tag-name
            *ngIf="segments"
            [nameSegments]="segments"></cvc-mp-tag-name>
          <span
            *ngIf="!segments"
            nz-typography
            nzType="secondary">
            Valid Molecular Profile expressions will be previewed here.
          </span>
        </ng-container>
      </div>
    </nz-col>
  </nz-row>

  <nz-row [nzGutter]="[6, 6]">
    <!-- input textarea -->
    <nz-col nzFlex="auto">
      <textarea
        nz-input
        rows="1"
        style="width: 100%"
        placeholder="Enter or edit a Molecular Expression here."
        [ngModel]="inputValue$ | ngrxPush"
        (ngModelChange)="onInputChange$.next($event)"></textarea>
    </nz-col>
    <nz-col nzFlex="50px">
      <button
        type="button"
        nz-button
        nzType="default"
        nzBlock
        nz-popover
        nzPopoverTitle="Append Variant #VID to Expression"
        nzPopoverTrigger="click"
        [nzPopoverContent]="appendVariant"
        nzPopoverPlacement="bottom">
        <span
          nz-icon
          nzType="arrow-left"></span>
        Append&nbsp;#VID
      </button>
      <ng-template #appendVariant>
        <div style="min-width: 350px">
          <p
            nz-typography
            nzType="secondary"
            style="margin: 0; padding-bottom: 6px">
            Select a Gene then a Variant to append its VID:
          </p>
          <cvc-mp-finder
            (cvcOnVariantSelect)="
              onVariantSelect$.next($event)
            "></cvc-mp-finder>
        </div>
      </ng-template>
    </nz-col>
  </nz-row>
</cvc-form-submission-status-display>
