<nz-card
  [nzTitle]="cardTitle"
  [nzExtra]="extraTemplate"
  nzSize="small">
  <nz-table
    #virtualTable
    *ngrxLet="row$ as data"
    [nzData]="data || []"
    cvcTableScroller
    (cvcTableScrollerOnScroll)="onScroll$.next($event)"
    (cvcTableScrollerOnFetch)="onFetch$.next($event)"
    [cvcTableScrollerQueryRef]="queryRef"
    [cvcTableScrollerPageInfo]="pageInfo$ | ngrxPush"
    [cvcTableScrollerToIndex]="(scrollToIndex$ | ngrxPush)!"
    [nzScroll]="{ x: '800px', y: '200px' }"
    [nzVirtualForTrackBy]="trackByIndex"
    [nzVirtualItemSize]="28"
    [nzSize]="'small'"
    [nzFrontPagination]="false"
    [nzShowPagination]="false"
    [nzLoading]="(loading$ | ngrxPush) && !(isFetchMore$ | ngrxPush)">
    <!-- col$ provide col config defaults and query param, table prefs updates -->
    <thead *ngrxLet="col$ as cols">
      <tr class="col-header-row">
        <ng-container *ngFor="let col of cols">
          <ng-container *ngIf="!col.hidden">
            <!-- SELECT HEADER -->
            <th
              *ngIf="col | guardType : colGuards.isSelectCol as opt"
              [nzShowCheckbox]="opt.checkbox.th.showCheckbox || false"
              [nzWidth]="opt.width"
              [nzAlign]="opt.align ?? 'left'"
              [nzLeft]="opt.fixedLeft || false"
              [nzRight]="opt.fixedRight || false"></th>

            <!-- ENTITY TAG HEADER -->
            <th
              *ngIf="col | guardType : colGuards.isEntityTagCol as opt"
              [nzColumnKey]="opt.key"
              [nzAlign]="opt.align ?? 'left'"
              [nzWidth]="opt.width"
              [nzLeft]="opt.fixedLeft || false"
              [nzRight]="opt.fixedRight || false"
              [nzShowSort]="opt.sort !== undefined"
              [nzSortFn]="true"
              [nzSortOrder]="opt.sort?.default || null"
              (nzSortOrderChange)="
                opt.sort!.changes!.next({ key: opt.key, value: $event })
              ">
              {{ opt.label }}
            </th>

            <!-- ENUM TAG HEADER -->
            <th
              *ngIf="col | guardType : colGuards.isEnumTagCol as opt"
              [nzColumnKey]="opt.key"
              [nzAlign]="opt.align ?? 'left'"
              [nzWidth]="opt.width"
              [nzLeft]="opt.fixedLeft || false"
              [nzRight]="opt.fixedRight || false">
              {{ opt.label }}
              <!-- <span
                            nz-tooltip
                            [nzTooltipTitle]="debugTooltip"
                            [nzTooltipTitleContext]="opt.filter"
                            nz-icon
                            nzType="bug"
                            nzTheme="outline"></span>
                          <ng-template
                            #debugTooltip
                            let-filter>
                            <pre>{{ opt.filter.options | json }}</pre>
                          </ng-template> -->
            </th>

            <!-- TEXT TAG HEADER -->
            <th
              *ngIf="col | guardType : colGuards.isTextTagCol as opt"
              [nzColumnKey]="opt.key"
              [nzAlign]="opt.align ?? 'left'"
              [nzWidth]="opt.width"
              [nzLeft]="opt.fixedLeft || false"
              [nzRight]="opt.fixedRight || false">
              {{ opt.label }}
            </th>
          </ng-container>
        </ng-container>
      </tr>

      <tr class="filter-row">
        <ng-container *ngFor="let col of cols">
          <ng-container *ngIf="!col.hidden">
            <!-- SELECT FILTER -->
            <th
              *ngIf="col | guardType : colGuards.isSelectCol as opt"
              [nzColumnKey]="opt.key"
              [nzAlign]="opt.align ?? 'left'"
              [nzWidth]="opt.width"
              [nzLeft]="opt.fixedLeft || false"
              [nzRight]="opt.fixedRight || false">
              &nbsp;
            </th>

            <!-- ENTITY TAG FILTER -->
            <th
              *ngIf="col | guardType : colGuards.isEntityTagCol as opt"
              [nzColumnKey]="opt.key"
              [nzWidth]="opt.width"
              [nzAlign]="opt.align ?? 'left'"
              [nzLeft]="opt.fixedLeft || false"
              [nzRight]="opt.fixedRight || false">
              <cvc-table-filter-input
                *ngIf="opt.filter as filter"
                [cvcPlaceholder]="opt.filter.options[0].key"
                [cvcModel]="opt.filter.options[0].value"
                (cvcModelChange)="
                  filter.changes!.next({ key: opt.key, value: $event })
                ">
              </cvc-table-filter-input>
            </th>

            <!-- ENUM TAG FILTER -->
            <th
              #enumTableFilter
              *ngIf="col | guardType : colGuards.isEnumTagCol as opt"
              [nzColumnKey]="opt.key"
              class="attribute-filter"
              [nzWidth]="opt.width"
              [nzAlign]="opt.align ?? 'left'"
              [nzLeft]="opt.fixedLeft || false"
              [nzRight]="opt.fixedRight || false"
              [nzShowSort]="true"
              [nzSortFn]="true"
              [nzSortOrder]="opt.sort?.default || null"
              (nzSortOrderChange)="
                opt.sort!.changes!.next({ key: opt.key, value: $event })
              "
              nzCustomFilter
              [nzShowFilter]="opt.filter !== undefined"
              [nzFilterFn]="true">
              <nz-filter-trigger
                #enumTagFilterTrigger
                [nzDropdownMenu]="enumFilterMenu"
                [nzActive]="(opt.filter.changes | ngrxPush)?.value !== null">
                <span
                  nz-icon
                  nzType="filter"
                  nzTheme="fill"></span>
              </nz-filter-trigger>
              <nz-dropdown-menu #enumFilterMenu="nzDropdownMenu">
                <cvc-enum-filter-menu
                  [cvcColumnKey]="opt.key"
                  [cvcFilterOptions]="opt.filter.options"
                  [cvcOption]="opt.filter.changes | ngrxPush"
                  (cvcOptionChange)="
                    opt.filter.changes!.next($event);
                    enumTagFilterTrigger.nzVisible = false
                  ">
                </cvc-enum-filter-menu>
              </nz-dropdown-menu>
            </th>

            <!-- TEXT TAG FILTER -->
            <th
              #enumTableFilter
              *ngIf="col | guardType : colGuards.isTextTagCol as opt"
              [nzColumnKey]="opt.key"
              class="attribute-filter"
              [nzWidth]="opt.width"
              [nzAlign]="opt.align ?? 'left'"
              [nzLeft]="opt.fixedLeft || false"
              [nzRight]="opt.fixedRight || false"
              nzCustomFilter
              [nzFilterFn]="true">
              <nz-filter-trigger
                [nzDropdownMenu]="textTagFilterMenu"
                [nzActive]="(opt.filter.changes | ngrxPush)?.value !== null">
                <span
                  nz-icon
                  nzType="search"></span>
              </nz-filter-trigger>
              <nz-dropdown-menu #textTagFilterMenu="nzDropdownMenu">
                <div class="ant-table-filter-dropdown">
                  <div class="custom-input-dropdown">
                    <cvc-table-filter-input
                      [cvcPlaceholder]="
                        opt.filter.options[0] && opt.filter.options[0].key
                      "
                      [cvcModel]="
                        opt.filter.options[0] && opt.filter.options[0].value
                      "
                      (cvcModelChange)="
                        opt.filter.changes!.next({
                          key: opt.key,
                          value: $event
                        })
                      ">
                    </cvc-table-filter-input>
                  </div>
                </div>
              </nz-dropdown-menu>
            </th>
          </ng-container>
        </ng-container>
      </tr>
    </thead>

    <tbody *ngrxLet="col$ as cols">
      <ng-template
        nz-virtual-scroll
        let-row>
        <tr class="data-row">
          <ng-container *ngFor="let col of cols">
            <ng-container *ngIf="!col.hidden">
              <!-- SELECT CELL -->
              <td
                *ngIf="col | guardType : colGuards.isSelectCol as opt"
                [nzChecked]="row.selected"
                (nzCheckedChange)="
                  onRowSelected$.next({ id: row.id, selected: $event })
                "
                [nzAlign]="opt.align ?? 'left'"
                [nzLeft]="opt.fixedLeft || false"
                [nzRight]="opt.fixedRight || false"></td>

              <!-- ENTITY TAG CELL -->
              <td
                *ngIf="col | guardType : colGuards.isEntityTagCol as opt"
                [nzAlign]="opt.align ?? 'left'"
                [nzLeft]="opt.fixedLeft || false"
                [nzRight]="opt.fixedRight || false">
                <ng-container *ngIf="opt.context || opt.key as colKey">
                  <cvc-entity-tag
                    *ngIf="!opt.tagGroup; else multiTag"
                    [cvcCacheId]="
                      row[colKey].__typename + ':' + row[colKey].id
                    "></cvc-entity-tag>

                  <!-- TODO: wrap in new entity-tag-list -->
                  <ng-template #multiTag>
                    <cvc-entity-tag
                      *ngFor="let entity of row[colKey]"
                      [cvcCacheId]="
                        entity.__typename + ':' + entity.id
                      "></cvc-entity-tag>
                  </ng-template>
                </ng-container>
              </td>

              <!-- ENUM TAG CELL -->
              <td
                *ngIf="col | guardType : colGuards.isEnumTagCol as opt"
                nzAlign="center"
                [nzAlign]="opt.align ?? 'left'"
                [nzLeft]="opt.fixedLeft || false"
                [nzRight]="opt.fixedRight || false">
                <cvc-attribute-tag
                  *ngIf="row[opt.key]; else emptyCell"
                  [cvcAttrValue]="row[opt.key]"
                  [cvcShowLabel]="opt.showLabel ?? false"
                  [cvcShowIcon]="opt.showIcon ?? true"
                  [cvcTooltip]="
                    row[opt.key] | evidenceEnumDisplay
                  "></cvc-attribute-tag>
              </td>

              <!-- TEXT TAG CELL -->
              <td
                *ngIf="col | guardType : colGuards.isTextTagCol as opt"
                nzAlign="center"
                [nzAlign]="opt.align ?? 'left'"
                [nzLeft]="opt.fixedLeft || false"
                [nzRight]="opt.fixedRight || false">
                <!-- TODO: show filter text emphasized in tooltip text -->
                <nz-tag
                  nz-tooltip
                  [nzTooltipTitle]="row[opt.key]">
                  <span
                    nz-icon
                    nzType="align-left"
                    nzTheme="outline"></span>
                </nz-tag>
              </td>
            </ng-container>
          </ng-container>
        </tr>
      </ng-template>
    </tbody>
  </nz-table>
</nz-card>

<!-- string/number input custom filter -->
<ng-template
  #columnFilterInput
  let-columnKey
  let-filter="filter">
  <!-- input updates onFilterChange -->
  <ng-container
    *ngIf="
      filter.type === undefined || filter.type === 'string';
      else numericInput
    ">
    <nz-input-group
      [nzSuffix]="suffixIcon"
      nzSize="small">
      <input
        #filterInput
        nz-input
        [placeholder]="filter.placeholder"
        [ngModel]="filter.defaultValue"
        (nzFilterChange)="
          filter.changes.next({ key: filter.key, value: $event })
        " />
    </nz-input-group>

    <!-- input suffic icon tpl - magnifying glass if unset, clear icon if set  -->
    <ng-template #suffixIcon>
      <span
        *ngIf="!filterInput.value"
        nz-icon
        nzType="search"
        style="color: #ddd"></span>
      <span
        *ngIf="filterInput.value"
        nz-icon
        class="ant-input-clear-icon"
        nzTheme="fill"
        nzType="close-circle"
        (click)="
          filterInput.value = '';
          filter.changes.next({ key: filter.key, value: null })
        "></span>
    </ng-template>
  </ng-container>

  <ng-template #numericInput>
    <nz-input-number-group nzSize="small">
      <nz-input-number
        #filterInput
        [nzPlaceHolder]="filter.placeholder"
        [ngModel]="filter.defaultValue"
        style="width: 100%"
        (ngModelChange)="
          filter.changes.next({ key: filter.key, value: $event })
        "
        [nzMin]="1"
        [nzStep]="1"></nz-input-number>
    </nz-input-number-group>
  </ng-template>
</ng-template>

<ng-template #emptyCell>
  <span
    nz-typeography
    nzType="secondary">
    --
  </span>
</ng-template>

<ng-template #cardTitle>
  <nz-row [nzGutter]="[6, 6]">
    <nz-col>
      <span>Use checkboxes to select or deselect EIDs</span>
    </nz-col>
  </nz-row>
</ng-template>

<!-- card's extra template - loading/error indicators & prefs button-->
<ng-template #extraTemplate>
  <nz-row [nzGutter]="8">
    <nz-col nzFlex="auto">
      <!-- loading more rows -->
      <nz-tag
        *ngIf="(loading$ | ngrxPush) && (isFetchMore$ | ngrxPush)"
        nzColor="processing">
        <i
          nz-icon
          nzType="sync"
          nzSpin></i>
        <span>Loading…</span>
      </nz-tag>

      <!-- no more rows to load -->
      <cvc-no-more-rows
        [cvcShowTag]="noMoreRows$ | ngrxPush"></cvc-no-more-rows>
    </nz-col>
    <!-- loading, no more rows, and error tags -->
    <nz-col nzFlex="auto">
      <ng-container *ngrxLet="queryError$ as errors">
        <!-- request & network errors -->
        <ng-container *ngIf="errors">
          <nz-tag
            *ngIf="errors.query"
            nzColor="error"
            style="margin-left: 12px">
            <span
              nz-icon
              nzType="question-circle"
              nzTheme="outline"></span>
            <span
              nz-tooltip
              [nzTooltipTitle]="queryError"
              [nzTooltipTitleContext]="{ $implicit: errors.query }"
              style="cursor: help">
              Query Error{{ errors.query!.length > 1 ? 's' : '' }}
            </span>
          </nz-tag>
          <nz-tag
            *ngIf="errors.network"
            nzColor="error"
            style="margin-left: 12px">
            <span
              nz-tooltip
              [nzTooltipTitle]="queryError"
              [nzTooltipTitleContext]="{ $implicit: errors.network }"
              style="cursor: help">
              <span nz-typography>
                <strong>
                  Network Error{{ errors.query!.length > 1 ? 's' : '' }}
                </strong>
              </span>
            </span>
          </nz-tag>
          <ng-template
            #queryError
            let-errors>
            <div *ngFor="let error of errors">
              {{ error.message }}
            </div>
          </ng-template>
        </ng-container>
      </ng-container>
    </nz-col>
    <nz-col nzFlex="auto">
      <cvc-table-counts
        [cvcTableCountsConnection]="connection$"></cvc-table-counts>
    </nz-col>

    <!-- card button row -->
    <nz-col nzFlex="35px">
      <nz-button-group>
        <button
          nz-button
          type="button"
          nzType="default"
          nzSize="small"
          (click)="onResetFilter$.next()">
          <span
            nz-icon
            nzType="retweet"
            nzTheme="outline"></span>
        </button>
        <button
          nz-button
          nz-popover
          nzPopoverTitle="Visible Columns"
          [nzPopoverContent]="prefsPopover"
          [nzPopoverTrigger]="'click'"
          type="button"
          nzType="default"
          nzSize="small">
          <span
            nz-icon
            nzType="setting"
            nzTheme="outline"></span>
        </button>
      </nz-button-group>
      <ng-template #prefsPopover>
        <div class="prefs-popover">
          <nz-checkbox-group
            [ngModel]="updatePreferenceOptions$ | ngrxPush"
            (ngModelChange)="
              onPreferenceChange$.next($event)
            "></nz-checkbox-group>
        </div>
      </ng-template>
    </nz-col>
  </nz-row>
</ng-template>
