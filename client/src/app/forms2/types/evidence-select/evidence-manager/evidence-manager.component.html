<nz-card
  [nzTitle]="cardTitle"
  [nzExtra]="extraTemplate"
  nzSize="small">
  <nz-table
    #virtualTable
    #columnTable
    #rowSelectionTable
    cvcTableScroller
    (cvcTableScrollerOnScroll)="scrollEvent$.next($event)"
    (cvcTableScrollerOnFetch)="onFetch$.next($event)"
    [cvcTableScrollerQueryRef]="queryRef"
    [cvcTableScrollerPageInfo]="pageInfo$ | ngrxPush"
    [cvcTableScrollerToIndex]="(scrollIndex$ | ngrxPush)!"
    *ngrxLet="row$ as data"
    [nzData]="data || []"
    [nzScroll]="{ x: '1024px', y: '200px' }"
    [nzVirtualForTrackBy]="trackByIndex"
    [nzVirtualItemSize]="28"
    [nzFrontPagination]="false"
    [nzShowPagination]="false"
    [nzLoading]="(loading$ | ngrxPush) && !(isFetchMore$ | ngrxPush)"
    nzSize="small"
    (nzQueryParams)="onTableQueryParams$.next($event)">
    <thead *ngrxLet="col$ as cols">
      <tr class="col-header-row">
        <th
          *ngIf="!cols.selected.hide"
          nzAlign="left"
          nzLeft
          [nzWidth]="cols.selected.width"
          [nzShowCheckbox]="false"></th>
        <th
          *ngIf="!cols.id.hide"
          [nzWidth]="cols.id.width"
          nzColumnKey="id">
          {{ cols.id.name }}
        </th>
        <th
          *ngIf="!cols.evidenceItem.hide"
          [nzWidth]="cols.evidenceItem.width"
          nzColumnKey="evidenceItem"
          [nzShowSort]="cols.evidenceItem.showSort"
          [nzSortFn]="true">
          {{ cols.evidenceItem.name }}
        </th>
        <th
          *ngIf="!cols.molecularProfile.hide"
          [nzWidth]="cols.molecularProfile.width"
          nzColumnKey="molecularProfile"
          [nzShowSort]="true"
          [nzSortFn]="true">
          {{ cols.molecularProfile.name }}
        </th>
        <th
          *ngIf="!cols.disease.hide"
          [nzWidth]="cols.disease.width"
          nzColumnKey="disease"
          [nzShowSort]="true"
          [nzSortFn]="true">
          {{ cols.disease.name }}
        </th>
        <th
          *ngIf="!cols.therapies.hide"
          [nzWidth]="cols.therapies.width"
          nzColumnKey="therapies"
          [nzShowSort]="true"
          [nzSortFn]="true">
          {{ cols.therapies.name }}
        </th>
        <th
          *ngIf="!cols.therapyInteractionType.hide"
          nzColumnKey="therapyInteractionType"
          [nzWidth]="cols.therapyInteractionType.width">
          {{ cols.therapyInteractionType.name }}
        </th>
        <th
          *ngIf="!cols.description.hide"
          nzColumnKey="description"
          [nzWidth]="cols.description.width">
          {{ cols.description.name }}
        </th>
        <th
          *ngIf="!cols.evidenceLevel.hide"
          [nzWidth]="cols.evidenceLevel.width"
          nzColumnKey="evidenceLevel"
          [nzShowSort]="true"
          [nzSortFn]="true">
          {{ cols.evidenceLevel.name }}
        </th>
        <th
          *ngIf="!cols.evidenceType.hide"
          [nzWidth]="cols.evidenceType.width"
          nzColumnKey="evidenceType"
          [nzShowSort]="true"
          [nzSortFn]="true">
          {{ cols.evidenceType.name }}
        </th>
        <th
          *ngIf="!cols.evidenceDirection.hide"
          [nzWidth]="cols.evidenceDirection.width"
          nzColumnKey="evidenceDirection"
          [nzShowSort]="true"
          [nzSortFn]="true">
          {{ cols.evidenceDirection.name }}
        </th>
        <th
          *ngIf="!cols.significance.hide"
          [nzWidth]="cols.significance.width"
          nzColumnKey="significance"
          [nzShowSort]="true"
          [nzSortFn]="true">
          {{ cols.significance.name }}
        </th>
        <th
          *ngIf="!cols.variantOrigin.hide"
          [nzWidth]="cols.variantOrigin.width"
          nzColumnKey="variantOrigin"
          [nzShowSort]="true"
          [nzSortFn]="true">
          {{ cols.variantOrigin.name }}
        </th>
        <th
          *ngIf="!cols.evidenceRating.hide"
          [nzWidth]="cols.evidenceRating.width"
          nzColumnKey="evidenceRating"
          [nzShowSort]="true"
          [nzSortFn]="true">
          {{ cols.evidenceRating.name }}
        </th>
      </tr>
      <tr class="filter-row">
        <th
          *ngIf="!cols.selected.hide"
          nzColumnKey="selected"
          nzLeft
          [nzWidth]="cols.selected.width"></th>
        <th
          *ngIf="!cols.id.hide"
          nzColumnKey="id"
          [nzWidth]="cols.id.width"></th>
        <th
          *ngIf="!cols.evidenceItem.hide"
          nzColumnKey="evidenceItem"
          [nzWidth]="cols.evidenceItem.width">
          <ng-container
            *ngTemplateOutlet="
              columnFilterInput;
              context: {
                $implicit: 'evidenceItem',
                options: cols.evidenceItem.filter!.options
              }
            "></ng-container>
        </th>
        <th
          *ngIf="!cols.molecularProfile.hide"
          nzColumnKey="molecularProfile"
          [nzWidth]="cols.molecularProfile.width">
          <ng-container
            *ngTemplateOutlet="
              columnFilterInput;
              context: {
                $implicit: 'molecularProfile',
                options: cols.molecularProfile.filter!.options
              }
            "></ng-container>
        </th>
        <th
          *ngIf="!cols.disease.hide"
          nzColumnKey="disease"
          [nzWidth]="cols.disease.width">
          <ng-container
            *ngTemplateOutlet="
              columnFilterInput;
              context: {
                $implicit: 'disease',
                options: cols.disease.filter!.options
              }
            "></ng-container>
        </th>
        <th
          *ngIf="!cols.therapies.hide"
          nzColumnKey="therapies"
          [nzWidth]="cols.therapies.width">
          <ng-container
            *ngTemplateOutlet="
              columnFilterInput;
              context: {
                $implicit: 'therapies',
                options: cols.therapies.filter!.options
              }
            "></ng-container>
        </th>
        <th
          *ngIf="!cols.therapyInteractionType.hide"
          nzColumnKey="therapyInteractionType"
          class="attribute-filter"
          [nzWidth]="cols.therapyInteractionType.width"
          [nzShowFilter]="true"
          [nzFilterFn]="true"></th>
        <th
          *ngIf="!cols.description.hide"
          nzColumnKey="description"
          class="attribute-filter"
          [nzWidth]="cols.description.width"
          [nzShowFilter]="true"
          [nzFilterFn]="true"></th>
        <th
          *ngIf="!cols.evidenceLevel.hide"
          nzColumnKey="evidenceLevel"
          class="attribute-filter"
          [nzWidth]="cols.evidenceLevel.width"
          nzAlign="center"
          [nzShowFilter]="true"
          [nzFilters]="cols.evidenceLevel.filter!.options"
          [nzFilterMultiple]="cols.evidenceType.filter!.multiple || false"
          [nzFilterFn]="true"></th>
        <th
          *ngIf="!cols.evidenceType.hide"
          nzColumnKey="evidenceType"
          class="attribute-filter"
          [nzWidth]="cols.evidenceType.width"
          nzAlign="center"
          [nzShowFilter]="true"
          [nzFilters]="cols.evidenceType.filter!.options"
          [nzFilterMultiple]="cols.evidenceType.filter!.multiple || false"
          [nzFilterFn]="true"></th>
        <th
          *ngIf="!cols.evidenceDirection.hide"
          nzColumnKey="evidenceDirection"
          class="attribute-filter"
          [nzWidth]="cols.evidenceDirection.width"
          nzAlign="center"
          [nzShowFilter]="true"
          [nzFilters]="cols.evidenceDirection.filter!.options"
          [nzFilterMultiple]="cols.evidenceType.filter!.multiple || false"
          [nzFilterFn]="true"></th>
        <th
          *ngIf="!cols.significance.hide"
          nzColumnKey="significance"
          class="attribute-filter"
          [nzWidth]="cols.significance.width"
          nzAlign="center"
          [nzShowFilter]="true"
          [nzFilters]="cols.significance.filter!.options"
          [nzFilterMultiple]="cols.evidenceType.filter!.multiple || false"
          [nzFilterFn]="true"></th>
        <th
          *ngIf="!cols.variantOrigin.hide"
          nzColumnKey="variantOrigin"
          class="attribute-filter"
          [nzWidth]="cols.variantOrigin.width"
          nzAlign="center"
          [nzShowFilter]="true"
          [nzFilters]="cols.variantOrigin.filter!.options"
          [nzFilterMultiple]="cols.evidenceType.filter!.multiple || false"
          [nzFilterFn]="true"></th>
        <th
          *ngIf="!cols.evidenceRating.hide"
          nzColumnKey="evidenceRating"
          class="attribute-filter"
          [nzWidth]="cols.evidenceRating.width"
          nzAlign="center"
          [nzShowFilter]="true"
          [nzFilters]="cols.evidenceRating.filter!.options"
          [nzFilterMultiple]="cols.evidenceType.filter!.multiple || false"
          [nzFilterFn]="true"></th>
      </tr>
    </thead>

    <tbody>
      <ng-template
        nz-virtual-scroll
        let-row>
        <tr
          class="data-row"
          *ngrxLet="col$ as cols">
          <td
            *ngIf="!cols.selected.hide"
            nzLeft
            [nzChecked]="row.selected"
            nzAlign="left"
            (nzCheckedChange)="
              onRowSelected$.next({ id: row.id, selected: $event })
            "></td>

          <td *ngIf="!cols.id.hide">
            {{ row.id }}
          </td>

          <td *ngIf="!cols.evidenceItem.hide">
            <cvc-entity-tag
              [cvcCacheId]="
                'EvidenceItem' + ':' + row.evidenceItem.id
              "></cvc-entity-tag>
          </td>

          <td *ngIf="!cols.molecularProfile.hide">
            <cvc-entity-tag
              [cvcCacheId]="
                'MolecularProfile' + ':' + row.molecularProfile.id
              "></cvc-entity-tag>
          </td>

          <td *ngIf="!cols.disease.hide">
            <cvc-entity-tag
              [cvcCacheId]="'Disease' + ':' + row.disease.id"></cvc-entity-tag>
          </td>

          <td *ngIf="!cols.therapies.hide">
            <cvc-entity-tag
              *ngFor="let therapy of row.therapies"
              [cvcCacheId]="'Therapy' + ':' + therapy.id"></cvc-entity-tag>
          </td>

          <td *ngIf="!cols.therapyInteractionType.hide">IT</td>

          <td *ngIf="!cols.description.hide">DESC</td>
          <td
            *ngIf="!cols.evidenceLevel.hide"
            nzAlign="center">
            {{ row.evidenceLevel }}
          </td>

          <td
            *ngIf="!cols.evidenceType.hide"
            nzAlign="center">
            <cvc-attribute-tag
              [cvcAttrValue]="row.evidenceType"
              [cvcShowLabel]="false"
              [cvcTooltip]="
                row.evidenceType | evidenceEnumDisplay
              "></cvc-attribute-tag>
          </td>

          <td
            *ngIf="!cols.evidenceDirection.hide"
            nzAlign="center">
            <cvc-attribute-tag
              [cvcAttrValue]="row.evidenceDirection"
              [cvcShowLabel]="false"
              [cvcTooltip]="
                row.evidenceDirection | evidenceEnumDisplay
              "></cvc-attribute-tag>
          </td>

          <td
            *ngIf="!cols.significance.hide"
            nzAlign="center">
            <cvc-attribute-tag
              [cvcAttrValue]="row.significance"
              [cvcShowLabel]="false"
              [cvcTooltip]="
                row.significance | evidenceEnumDisplay
              "></cvc-attribute-tag>
          </td>

          <td
            *ngIf="!cols.variantOrigin.hide"
            nzAlign="center">
            <cvc-attribute-tag
              [cvcAttrValue]="row.variantOrigin"
              [cvcShowLabel]="false"
              [cvcTooltip]="
                row.variantOrigin | evidenceEnumDisplay
              "></cvc-attribute-tag>
          </td>

          <td
            *ngIf="!cols.evidenceRating.hide"
            nzAlign="center">
            {{ row.evidenceRating }}
          </td>
        </tr>
      </ng-template>
    </tbody>
  </nz-table>
</nz-card>

<!-- col header input for typeahead filter -->
<ng-template
  #columnFilterInput
  let-columnKey
  let-options="options">
  <nz-input-group
    [nzSuffix]="suffixIcon"
    nzSize="small">
    <!--  -->
    <input
      #filterInput
      nz-input
      [placeholder]="options[0].text"
      [ngModel]="options[0].value || ''"
      (ngModelChange)="
        onCustomFilter$.next({ key: columnKey, value: $event })
      " />
  </nz-input-group>

  <!-- input suffic icon tpl - magnifying glass if unset, clear icon if set  -->
  <ng-template #suffixIcon>
    <span
      *ngIf="!filterInput.value"
      nz-icon
      nzType="search"
      style="color: #ddd"></span>
    <span
      *ngIf="filterInput.value"
      nz-icon
      class="ant-input-clear-icon"
      nzTheme="fill"
      nzType="close-circle"
      (click)="
        filterInput.value = '';
        onCustomFilter$.next({ key: columnKey, value: '' })
      "></span>
  </ng-template>
</ng-template>

<ng-template #emptyCell>
  <span
    nz-typeography
    nzType="secondary">
    --
  </span>
</ng-template>

<ng-template #cardTitle>
  <nz-row>
    <nz-col>
      <span>Use checkboxes to select or deselect EIDs</span>
    </nz-col>
    <nz-col>
    <cvc-table-counts
      [cvcTableCountsConnection]="connection$"></cvc-table-counts>
    </nz-col>
  </nz-row>
</ng-template>

<!-- card's extra template - loading/error indicators & prefs button-->
<ng-template #extraTemplate>
  <nz-row [nzGutter]="8">
    <!-- loading, no more rows, and error tags -->
    <nz-col nzFlex="auto">
      <ng-container *ngrxLet="requestError$ as errors">
        <!-- loading more rows -->
        <ng-container *ngIf="!errors?.query">
          <nz-tag
            *ngIf="(loading$ | ngrxPush) && (isFetchMore$ | ngrxPush)"
            nzColor="processing">
            <i
              nz-icon
              nzType="sync"
              nzSpin></i>
            <span>Loadingâ€¦</span>
          </nz-tag>

          <!-- no more rows to load -->
          <cvc-no-more-rows
            [cvcShowTag]="noMoreRows$ | ngrxPush"></cvc-no-more-rows>
        </ng-container>

        <!-- request & network errors -->
        <ng-container *ngIf="errors">
          <nz-tag
            *ngIf="errors.query"
            nzColor="error"
            style="margin-left: 12px">
            <span
              nz-icon
              nzType="question-circle"
              nzTheme="outline"></span>
            <span
              nz-tooltip
              [nzTooltipTitle]="queryError"
              [nzTooltipTitleContext]="{ $implicit: errors.query }"
              style="cursor: help">
              Query Error{{ errors.query!.length > 1 ? 's' : '' }}
            </span>
          </nz-tag>
          <nz-tag
            *ngIf="errors.network"
            nzColor="error"
            style="margin-left: 12px">
            <span
              nz-tooltip
              [nzTooltipTitle]="queryError"
              [nzTooltipTitleContext]="{ $implicit: errors.network }"
              style="cursor: help">
              <span nz-typography>
                <strong>
                  Network Error{{ errors.query!.length > 1 ? 's' : '' }}
                </strong>
              </span>
            </span>
          </nz-tag>
          <ng-template
            #queryError
            let-errors>
            <div *ngFor="let error of errors">
              {{ error.message }}
            </div>
          </ng-template>
        </ng-container>
      </ng-container>
    </nz-col>

    <!-- card button row -->
    <nz-col nzFlex="35px">
      <nz-button-group>
        <button
          nz-button
          type="button"
          nzType="default"
          nzSize="small">
          <span
            nz-icon
            nzType="retweet"
            nzTheme="outline"></span>
        </button>
        <button
          nz-button
          nz-popover
          nzPopoverTitle="Visible Columns"
          [nzPopoverContent]="prefsPopover"
          [nzPopoverTrigger]="'click'"
          type="button"
          nzType="default"
          nzSize="small">
          <span
            nz-icon
            nzType="setting"
            nzTheme="outline"></span>
        </button>
      </nz-button-group>
      <ng-template #prefsPopover>
        <div class="prefs-popover">
          <nz-checkbox-group
            [ngModel]="preferenceUpdate$ | ngrxPush"
            (ngModelChange)="onPreference$.next($event)"></nz-checkbox-group>
        </div>
      </ng-template>
    </nz-col>
  </nz-row>
</ng-template>
