<nz-card
  [nzTitle]="cardTitle"
  [nzExtra]="extraTemplate"
  nzSize="small">
  <nz-table
    #virtualTable
    *ngrxLet="row$ as data"
    [nzData]="data || []"
    cvcTableScroller
    (cvcTableScrollerOnScroll)="onScroll$.next($event)"
    (cvcTableScrollerOnFetch)="onFetch$.next($event)"
    [cvcTableScrollerQueryRef]="queryRef"
    [cvcTableScrollerPageInfo]="pageInfo$ | ngrxPush"
    [cvcTableScrollerToIndex]="(scrollToIndex$ | ngrxPush)!"
    [nzScroll]="{ x: '1024px', y: '200px' }"
    [nzVirtualForTrackBy]="trackByIndex"
    [nzVirtualItemSize]="28"
    [nzSize]="'small'"
    [nzFrontPagination]="false"
    [nzShowPagination]="false"
    [nzLoading]="(loading$ | ngrxPush) && !(isFetchMore$ | ngrxPush)"
    (nzQueryParams)="onTableQueryParams$.next($event)">
    <!-- col$ provide col config defaults and query param, table prefs updates -->
    <thead *ngrxLet="col$ as cols">
      <tr class="col-header-row">
        <ng-container *ngFor="let col of cols">
          <ng-container *ngIf="!col.hidden">
            <!-- SELECT HEADER -->
            <th
              *ngIf="col | guardType : colGuards.isSelectCol as opt"
              [nzShowCheckbox]="opt.checkbox.th.showCheckbox"
              [nzWidth]="opt.width"
              [nzLeft]="opt.fixedLeft || false"
              [nzRight]="opt.fixedRight || false"></th>

            <!-- ENTITY TAG HEADER -->
            <th
              *ngIf="col | guardType : colGuards.isEntityTagCol as opt"
              [nzColumnKey]="opt.key"
              [nzWidth]="opt.width"
              [nzLeft]="opt.fixedLeft || false"
              [nzRight]="opt.fixedRight || false">
              {{ opt.label }}
            </th>

            <!-- ENUM TAG HEADER -->
            <th
              *ngIf="col | guardType : colGuards.isEnumTagCol as opt"
              [nzColumnKey]="opt.key"
              [nzWidth]="opt.width"
              [nzLeft]="opt.fixedLeft || false"
              [nzRight]="opt.fixedRight || false">
              {{ opt.label }}
            </th>
          </ng-container>
        </ng-container>
      </tr>

      <tr class="filter-row">
        <ng-container *ngFor="let col of cols">
          <ng-container *ngIf="!col.hidden">

            <!-- SELECT FILTER -->
            <th
              *ngIf="col | guardType : colGuards.isSelectCol as opt"
              [nzColumnKey]="opt.key"
              [nzWidth]="opt.width"
              [nzLeft]="opt.fixedLeft || false"
              [nzRight]="opt.fixedRight || false">
              &nbsp;
            </th>

            <!-- ENTITY TAG FILTER -->
            <th
              *ngIf="col | guardType : colGuards.isEntityTagCol as opt"
              [nzColumnKey]="opt.key"
              [nzWidth]="opt.width"
              [nzLeft]="opt.fixedLeft || false"
              [nzRight]="opt.fixedRight || false">
              <ng-container
                *ngTemplateOutlet="
                  columnFilterInput;
                  context: {
                    $implicit: opt.key,
                    options: opt.filter.options
                  }
                "></ng-container>
            </th>

            <!-- ENUM TAG FILTER -->
            <th
              #enumTableFilter
              *ngIf="col | guardType : colGuards.isEnumTagCol as opt"
              [nzColumnKey]="col.key"
              class="attribute-filter"
              [nzWidth]="opt.width"
              [nzLeft]="opt.fixedLeft || false"
              [nzRight]="opt.fixedRight || false"
              [nzShowFilter]="true"
              [nzFilters]="opt.filter.options"
              [nzFilterMultiple]="false"
              [nzFilterFn]="true"></th>

          </ng-container>
        </ng-container>
      </tr>
    </thead>

    <tbody *ngrxLet="col$ as cols">
      <ng-template
        nz-virtual-scroll
        let-row>
        <tr class="data-row">
          <ng-container *ngFor="let col of cols">
            <ng-container *ngIf="!col.hidden">
              <!-- SELECT CELL -->
              <td
                *ngIf="col | guardType : colGuards.isSelectCol as opt"
                [nzChecked]="row.selected"
                (nzCheckedChange)="
                  onRowSelected$.next({ id: row.id, selected: $event })
                "
                [nzLeft]="opt.fixedLeft || false"
                [nzRight]="opt.fixedRight || false"></td>

              <!-- ENTITY TAG CELL -->
              <td
                *ngIf="col | guardType : colGuards.isEntityTagCol as opt"
                [nzLeft]="opt.fixedLeft || false"
                [nzRight]="opt.fixedRight || false">
                <cvc-entity-tag
                  *ngIf="!opt.tagGroup; else multiTag"
                  [cvcCacheId]="
                    row[opt.key].__typename + ':' + row[opt.key].id
                  "></cvc-entity-tag>

                <!-- TODO: wrap in new entity-tag-list -->
                <ng-template #multiTag>
                  <cvc-entity-tag
                    *ngFor="let entity of row[opt.key]"
                    [cvcCacheId]="
                      entity.__typename + ':' + entity.id
                    "></cvc-entity-tag>
                </ng-template>
              </td>

              <!-- ENUM TAG CELL -->
              <td
                *ngIf="col | guardType : colGuards.isEnumTagCol as opt"
                nzAlign="center"
                [nzLeft]="opt.fixedLeft || false"
                [nzRight]="opt.fixedRight || false">
                <cvc-attribute-tag
                  *ngIf="row[opt.key]; else emptyCell"
                  [cvcAttrValue]="row[opt.key]"
                  [cvcShowLabel]="opt.showLabel ?? false"
                  [cvcShowIcon]="opt.showIcon ?? true"
                  [cvcTooltip]="
                    row[opt.key] | evidenceEnumDisplay
                  "></cvc-attribute-tag>
              </td>
            </ng-container>
          </ng-container>
        </tr>
      </ng-template>
    </tbody>
  </nz-table>
</nz-card>

<!-- col header input for typeahead filter -->
<ng-template
  #columnFilterInput
  let-columnKey
  let-options="options">
  <!-- input updates onCustomFilter -->
  <nz-input-group
    [nzSuffix]="suffixIcon"
    nzSize="small">
    <input
      #filterInput
      nz-input
      [placeholder]="options[0].text"
      [ngModel]="options[0].value || ''"
      (ngModelChange)="
        onCustomFilter$.next({ key: columnKey, value: $event })
      " />
  </nz-input-group>

  <!-- input suffic icon tpl - magnifying glass if unset, clear icon if set  -->
  <ng-template #suffixIcon>
    <span
      *ngIf="!filterInput.value"
      nz-icon
      nzType="search"
      style="color: #ddd"></span>
    <span
      *ngIf="filterInput.value"
      nz-icon
      class="ant-input-clear-icon"
      nzTheme="fill"
      nzType="close-circle"
      (click)="
        filterInput.value = '';
        onCustomFilter$.next({ key: columnKey, value: '' })
      "></span>
  </ng-template>
</ng-template>

<ng-template #emptyCell>
  <span
    nz-typeography
    nzType="secondary">
    --
  </span>
</ng-template>

<ng-template #cardTitle>
  <nz-row [nzGutter]="[6, 6]">
    <nz-col>
      <span>Use checkboxes to select or deselect EIDs</span>
    </nz-col>
    <nz-col>
      <cvc-table-counts
        [cvcTableCountsConnection]="connection$"></cvc-table-counts>
    </nz-col>
  </nz-row>
</ng-template>

<!-- card's extra template - loading/error indicators & prefs button-->
<ng-template #extraTemplate>
  <nz-row [nzGutter]="8">
    <!-- loading, no more rows, and error tags -->
    <nz-col nzFlex="auto">
      <ng-container *ngrxLet="requestError$ as errors">
        <!-- loading more rows -->
        <ng-container *ngIf="!errors?.query">
          <nz-tag
            *ngIf="(loading$ | ngrxPush) && (isFetchMore$ | ngrxPush)"
            nzColor="processing">
            <i
              nz-icon
              nzType="sync"
              nzSpin></i>
            <span>Loadingâ€¦</span>
          </nz-tag>

          <!-- no more rows to load -->
          <cvc-no-more-rows
            [cvcShowTag]="noMoreRows$ | ngrxPush"></cvc-no-more-rows>
        </ng-container>

        <!-- request & network errors -->
        <ng-container *ngIf="errors">
          <nz-tag
            *ngIf="errors.query"
            nzColor="error"
            style="margin-left: 12px">
            <span
              nz-icon
              nzType="question-circle"
              nzTheme="outline"></span>
            <span
              nz-tooltip
              [nzTooltipTitle]="queryError"
              [nzTooltipTitleContext]="{ $implicit: errors.query }"
              style="cursor: help">
              Query Error{{ errors.query!.length > 1 ? 's' : '' }}
            </span>
          </nz-tag>
          <nz-tag
            *ngIf="errors.network"
            nzColor="error"
            style="margin-left: 12px">
            <span
              nz-tooltip
              [nzTooltipTitle]="queryError"
              [nzTooltipTitleContext]="{ $implicit: errors.network }"
              style="cursor: help">
              <span nz-typography>
                <strong>
                  Network Error{{ errors.query!.length > 1 ? 's' : '' }}
                </strong>
              </span>
            </span>
          </nz-tag>
          <ng-template
            #queryError
            let-errors>
            <div *ngFor="let error of errors">
              {{ error.message }}
            </div>
          </ng-template>
        </ng-container>
      </ng-container>
    </nz-col>

    <!-- card button row -->
    <nz-col nzFlex="35px">
      <nz-button-group>
        <button
          nz-button
          type="button"
          nzType="default"
          nzSize="small"
          (click)="onResetFilter$.next()">
          <span
            nz-icon
            nzType="retweet"
            nzTheme="outline"></span>
        </button>
        <button
          nz-button
          nz-popover
          nzPopoverTitle="Visible Columns"
          [nzPopoverContent]="prefsPopover"
          [nzPopoverTrigger]="'click'"
          type="button"
          nzType="default"
          nzSize="small">
          <span
            nz-icon
            nzType="setting"
            nzTheme="outline"></span>
        </button>
      </nz-button-group>
      <ng-template #prefsPopover>
        <div class="prefs-popover">
          <nz-checkbox-group
            [ngModel]="updatePreferenceOptions$ | ngrxPush"
            (ngModelChange)="onPreferenceChange$.next($event)"></nz-checkbox-group>
        </div>
      </ng-template>
    </nz-col>
  </nz-row>
</ng-template>
