@let endorsements = (endorsements$ | ngrxPush) || [];
@if (
  (endorsements.length > 0 &&
    ($viewer() | canEndorseAssertion: endorsements)) ||
  ($viewer() | canRevokeAssertion: endorsements)
) {
  <nz-alert
    nzType="info"
    [nzMessage]="endorsementMessage"
    nzShowIcon
    style="margin-bottom: 12px"></nz-alert>
  <ng-template #endorsementMessage>
    Your endorsement actions will be executed under the authority granted to you
    by
    <strong>{{ $viewer()?.mostRecentOrg?.name }}.</strong>
  </ng-template>
}
<nz-list
  [nzDataSource]="endorsements"
  [nzLoading]="loading$ | ngrxPush"
  [nzRenderItem]="endorsement"
  nzSize="small"
  nzItemLayout="vertical">
  <ng-template
    #endorsement
    let-endorsement>
    <nz-list-item [nzExtra]="itemExtra">
      <nz-list-item-meta
        [nzAvatar]="itemAvatar"
        [nzTitle]="itemTitle"
        [nzDescription]="itemDescription">
      </nz-list-item-meta>
    </nz-list-item>
    <ng-template #itemAvatar>
      <div class="organization-image-container">
        <img
          class="organization-image"
          src="{{ endorsement.organization.profileImagePath }}" />
      </div>
    </ng-template>
    <ng-template #itemTitle>
      <span class="endorsement-title">
        Endorsed by {{ endorsement.organization.name }}
      </span>
      <span class="endorsement-status">
        @switch (endorsement.status) {
          @case ('ACTIVE') {
            <nz-tag nzColor="success"> Active </nz-tag>
          }
          @case ('REQUIRES_REVIEW') {
            <nz-tag nzColor="processing"> Requires Review</nz-tag>
          }
          @case ('REVOKED') {
            <nz-tag nzColor="error"> Revoked </nz-tag>
          }
        }
      </span>
    </ng-template>
    <ng-template #itemDescription>
      <!-- endorsement summary -->
      <span
        nz-typography
        nzType="secondary"
        class="endorsement-summary">
        @switch (endorsement.status) {
          @case ('ACTIVE') {
            <strong>AID{{ assertionId }}</strong> has been endorsed by
            <strong>{{ endorsement.organization.name }}</strong> under the
            authority of editor
            <strong> {{ endorsement.user.displayName }}.</strong>
          }
          @case ('REVOKED') {
            <strong>AID{{ assertionId }}</strong> endorsement has been revoked
            by <strong>{{ endorsement.organization.name }}</strong> under the
            authority of editor
            <strong> {{ endorsement.user.displayName }}.</strong>
          }
          @case ('REQUIRES_REVIEW') {
            Post-endorsement changes to
            <strong>AID{{ assertionId }}</strong> require
            <strong>review by an endorsing editor.</strong>
          }
        }
      </span>
      @switch (endorsement.status) {
        @case ('ACTIVE') {
          <nz-collapse [nzBordered]="false">
            <nz-collapse-panel nzHeader="Show Endorsement Details">
              <div
                nz-flex
                nzVertical
                [nzGap]="8">
                <ng-container
                  *ngTemplateOutlet="endorsementDetails"></ng-container>
              </div>
            </nz-collapse-panel>
          </nz-collapse>
        }
        @case ('REVOKED') {
          <nz-collapse [nzBordered]="false">
            <nz-collapse-panel nzHeader="Show Revocation Details">
              <div
                nz-flex
                nzVertical
                [nzGap]="8">
                <ng-container
                  *ngTemplateOutlet="endorsementDetails"></ng-container>
              </div>
            </nz-collapse-panel>
          </nz-collapse>
        }
        @case ('REQUIRES_REVIEW') {
          <nz-collapse [nzBordered]="false">
            <nz-collapse-panel
              nzHeader="Show Unendorsed Changes"
              [nzActive]="true">
              <div
                nz-flex
                nzVertical
                [nzGap]="8">
                <ng-container
                  *ngTemplateOutlet="endorsementDetails"></ng-container>
                <div
                  class="revisions-container"
                  #revisionsContainer>
                  <cvc-activity-feed
                    [cvcFilters]="feedFilters(endorsement)"
                    [cvcSettings]="feedSettings()"
                    [cvcShowFilters]="false"
                    [cvcAutoHeightTarget]="revisionsContainer"
                    [cvcAutoHeightOffset]="-40"
                    cvcTitle="Unendorsed Changes"></cvc-activity-feed>
                </div>
              </div>
            </nz-collapse-panel>
          </nz-collapse>
        }
      }
      <!-- details template-->
      <ng-template #endorsementDetails>
        <nz-descriptions
          nzBordered
          nzLayout="vertical"
          nzSize="small"
          [nzColumn]="2">
          <nz-descriptions-item nzTitle="Endorsing Organization">
            <cvc-organization-tag
              [org]="endorsement.organization"
              [enablePopover]="false"></cvc-organization-tag>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Endorsed by">
            <cvc-user-tag
              [user]="endorsement.user"
              [enablePopover]="false"></cvc-user-tag>
            <span
              nz-typography
              nzType="secondary">
              {{ endorsement.lastReviewed | timeAgo }}
            </span>
          </nz-descriptions-item>
          @if (endorsement.revocationActivity) {
            <nz-descriptions-item
              nzTitle="Revocation Note"
              nzSpan="2">
              @if (endorsement.revocationActivity?.note) {
                <p nz-typography>
                  {{ endorsement.revocationActivity?.note }}
                </p>
              } @else {
                <p
                  nz-typography
                  nzType="secondary">
                  No note provided
                </p>
              }
            </nz-descriptions-item>
          }
        </nz-descriptions>
      </ng-template>
    </ng-template>
    <!-- endorsement status & action button -->
    <ng-template #itemExtra>
      @let viewer = $viewer();
      @if (
        endorsement.status === 'REQUIRES_REVIEW' &&
        viewer &&
        viewer.signedIn &&
        viewer.canModerate &&
        viewer.mostRecentOrg &&
        viewer.endorsableOrgIds.includes(endorsement.organization.id)
      ) {
        <button
          nz-button
          nzType="primary"
          nzBlock
          style="margin-bottom: 12px">
          Re-Endorse
        </button>
      }
      @if (
        (endorsement.status === 'ACTIVE' ||
          endorsement.status === 'REQUIRES_REVIEW') &&
        viewer &&
        viewer.signedIn &&
        viewer.canModerate &&
        viewer.mostRecentOrg &&
        viewer.endorsableOrgIds.includes(endorsement.organization.id)
      ) {
        <button
          nz-button
          nzType="primary"
          nzDanger
          nzBlock>
          Revoke
        </button>
      }
    </ng-template>
  </ng-template>
  <ng-container *ngIf="pageInfo$ | ngrxPush as pageInfo">
    <nz-list-footer *ngIf="pageInfo.hasNextPage">
      <div nz-list-load-more>
        <button
          nz-button
          nzType="link"
          nzSize="small"
          nzBlock
          (click)="onLoadMore(pageInfo.startCursor)">
          Load more
        </button>
      </div>
    </nz-list-footer>
  </ng-container>
</nz-list>
<!-- <h3>Endorsements</h3>
<pre>{{ endorsements | json }}</pre>
<h3>Viewer</h3>
<pre>{{ $viewer() | json }}</pre> -->
