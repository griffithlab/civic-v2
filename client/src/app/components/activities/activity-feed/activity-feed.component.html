<nz-card
  [nzTitle]="cardTitle"
  [nzExtra]="cardExtra"
  nzSize="small"
  style="width: 100%">
  <ng-template #cardTitle>
    <nz-space nzDirection="horizontal">
      <span
        class="title"
        *nzSpaceItem>
        {{ cvcTitle() }}
      </span>
      <cvc-activity-feed-counts
        *nzSpaceItem
        [cvcFeedCounts]="counts()"></cvc-activity-feed-counts>
      <span *nzSpaceItem>
        <nz-tag
          *ngIf="moreLoading()"
          nzColor="processing">
          <i
            nz-icon
            nzType="sync"
            nzSpin></i>
          <span>Loadingâ€¦</span>
        </nz-tag>
      </span>
    </nz-space>
  </ng-template>
  <ng-template #cardExtra>
    <cvc-activity-feed-settings
      (cvcSettingsChange)="onSettingChange$.next($event)"
      [cvcSettings]="cvcSettings()"
      [cvcScope]="cvcScope()">
    </cvc-activity-feed-settings>
  </ng-template>
  <nz-row [nzGutter]="[16, 8]">
    <!-- ACTIVITY FEED COLUMN -->
    <nz-col [nzSpan]="cvcShowFilters() ? 18 : 24">
      <div class="feed-container">
        <div class="feed-layers">
          <!-- messages layer - TOP -->
          <div class="messages">
            @if (zeroRows()) {
              <nz-result
                nzStatus="info"
                [nzTitle]="resultsMessage"></nz-result>
            }
          </div>
          <ng-template #resultsMessage>
            <div
              style="
                font-size: 18px;
                font-weight: 600;
                text-align: center;
                color: #666;
              ">
              No Activities found matching
              @if (cvcScope().mode === 'SUBJECT') {
                specified subject
              } @else if (cvcScope().mode === 'USER') {
                specified contributor
              } @else {
                specified filters
              }
            </div>
          </ng-template>
          <!-- scroller top/bottom dropshadows - MIDDLE -->
          <!-- TODO: control atBottom signal with allRowsLoaded$ -->
          <div class="boundaries">
            <!-- <div
              class="shadow-top"
              [@atTop]="scroller().isAtTop ? 'isAtTop' : 'isNotAtTop'"></div> -->
            <!-- <div
              class="shadow-bottom"
              [@atBottom]="
                scroller().isAtBottom && counts()?.rows === counts()?.total
                  ? 'isAtBottom'
                  : 'isNotAtBottom'
              "></div> -->
          </div>

          <!-- scroller layer - BOTTOM-->
          <div class="scroller">
            <nz-spin
              [nzSpinning]="refetchLoading()"
              nzSize="large"
              [nzDelay]="0">
              <div
                cvcAutoHeightDiv="40"
                cvcAutoHeightTarget="viewport">
                @if (scrollDatasource) {
                  <cvc-activity-feed-item
                    *uiScroll="
                      let edge of scrollDatasource;
                      routines: scrollerRoutines
                    "
                    [cvcActivity]="edge.node"
                    [cvcScope]="cvcScope()"></cvc-activity-feed-item>
                }
              </div>
            </nz-spin>
          </div>
        </div>
      </div>
    </nz-col>

    <!-- FEED FILTERS COLUMN -->
    <nz-col [nzSpan]="cvcShowFilters() ? 6 : 0">
      <!-- NOTE: setting nzSpan to 0 hides the filters column rather than removing it
           from the DOM as with *ngIf. Component initialization causes cvc-activity-feed-filters'
           feedFilter$ to emit, which is required to fire off an initial query -->
      <cvc-activity-feed-filters
        (cvcFiltersChange)="onFilterChange$.next($event)"
        [cvcFilterOptions]="feedFilterOptions()"
        [cvcFilters]="cvcFilters()"
        [cvcScope]="cvcScope()">
      </cvc-activity-feed-filters>
    </nz-col>
  </nz-row>
</nz-card>
<ng-template #cardExtra>
  <cvc-activity-feed-settings
    (cvcSettingsChange)="onSettingChange$.next($event)"
    [cvcSettings]="cvcSettings()"
    [cvcScope]="cvcScope()">
  </cvc-activity-feed-settings>
</ng-template>
