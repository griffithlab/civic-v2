  <nz-alert *ngFor="let error of this.errors" nzBanner [nzMessage]="error" nzType="error" nzCloseable (nzOnClose)="onErrorBannerClose(error)"></nz-alert>
  <nz-alert *ngIf="this.success" nzBanner nzMessage="Revision(s) successfully {{this.success}}." nzType="success" nzCloseable (nzOnClose)="onSuccessBannerClose()"></nz-alert>
  <nz-card nzTitle="Revisions"
    class="card-list" [nzExtra]="moderationButtons">
    <nz-collapse class="revision-list" *ngIf="revisions && revisions.length > 0; else noRevisions">
      <nz-collapse-panel
        *ngFor="let revision of untypedRevisons"
        [nzHeader]="revCardHeaderTitle"
        [nzExtra]="revCardHeaderExtra"
        [nzActive]="true"
      >
        <ng-container [ngSwitch]="revision.fieldName">
          <ng-container *ngSwitchCase="'source_ids'">
            <cvc-revision-list-diff
              [diffObject]="revision.linkoutData.diffValue"
              entityType="Sources">
              <ng-template #itemTemplate let-item>
                <cvc-source-tag [source]="item"></cvc-source-tag>
              </ng-template>
            </cvc-revision-list-diff>
          </ng-container>
          <ng-container *ngSwitchCase="'disease_id'">
            <cvc-revision-list-diff
              [diffObject]="revision.linkoutData.diffValue"
              entityType="Disease">
              <ng-template #itemTemplate let-item>
                <cvc-disease-tag [disease]="{id: item.id, name: item.displayName}"></cvc-disease-tag>
              </ng-template>
            </cvc-revision-list-diff>
          </ng-container>
          <ng-container *ngSwitchCase="'drug_ids'">
            <cvc-revision-list-diff
              [diffObject]="revision.linkoutData.diffValue"
              entityType="Drugs">
              <ng-template #itemTemplate let-item>
                <cvc-drug-tag [drug]="{id: item.id, name: item.displayName}"></cvc-drug-tag>
              </ng-template>
            </cvc-revision-list-diff>
          </ng-container>
          <ng-container *ngSwitchCase="'variant_alias_ids'">
            <cvc-revision-list-diff
              [diffObject]="revision.linkoutData.diffValue"
              entityType="Variant Aliases">
              <ng-template #itemTemplate let-item>
                <nz-tag>
                  {{ item.displayName }}
                </nz-tag>
              </ng-template>
            </cvc-revision-list-diff>
          </ng-container>
          <ng-container *ngSwitchCase="'clinvar_entry_ids'">
            <cvc-revision-list-diff
              [diffObject]="revision.linkoutData.diffValue"
              entityType="ClinVar Entries">
              <ng-template #itemTemplate let-item>
                <nz-tag>
                  {{ item.displayName }}
                </nz-tag>
              </ng-template>
            </cvc-revision-list-diff>
          </ng-container>
          <ng-container *ngSwitchCase="'hgvs_expression_ids'">
            <cvc-revision-list-diff
              [diffObject]="revision.linkoutData.diffValue"
              entityType="HGVS Expressions">
              <ng-template #itemTemplate let-item>
                <nz-tag>
                  {{ item.displayName }}
                </nz-tag>
              </ng-template>
            </cvc-revision-list-diff>
          </ng-container>
          <ng-container *ngSwitchCase="'variant_type_ids'">
            <cvc-revision-list-diff
              [diffObject]="revision.linkoutData.diffValue"
              entityType="Variant Types">
              <ng-template #itemTemplate let-item>
                <cvc-variant-type-tag [variantType]="{id: item.id, name: item.displayName}"></cvc-variant-type-tag>
              </ng-template>
            </cvc-revision-list-diff>
          </ng-container>
          <ng-container *ngSwitchCase="'phenotype_ids'">
            <cvc-revision-list-diff
              [diffObject]="revision.linkoutData.diffValue"
              entityType="Phenotypes">
              <ng-template #itemTemplate let-item>
                <cvc-phenotype-tag [phenotype]="{id: item.id, name: item.displayName}"></cvc-phenotype-tag>
              </ng-template>
            </cvc-revision-list-diff>
          </ng-container>
          <ng-container *ngSwitchCase="'variant_id'">
            <cvc-revision-list-diff
              [diffObject]="revision.linkoutData.diffValue"
              entityType="Variant">
              <ng-template #itemTemplate let-item>
                <cvc-variant-tag [variant]="{id: item.id, name: item.displayName}"></cvc-variant-tag>
              </ng-template>
            </cvc-revision-list-diff>
          </ng-container>
          <ng-container *ngSwitchCase="'source_id'">
            <cvc-revision-list-diff
              [diffObject]="revision.linkoutData.diffValue"
              entityType="Source">
              <ng-template #itemTemplate let-item>
                <cvc-source-tag [source]="item"></cvc-source-tag>
              </ng-template>
            </cvc-revision-list-diff>
          </ng-container>
          <ng-container *ngSwitchDefault>
            <!-- default text diff -->
            <cvc-revision-value-diff
              [currentValue]="revision.currentValue"
              [suggestedValue]="revision.suggestedValue"
              [left]="revision.linkoutData.diffValue.left"
              [right]="revision.linkoutData.diffValue.right"
              [entityType]="revision.linkoutData.name" ></cvc-revision-value-diff>
              </ng-container>
        </ng-container>
      <!-- header title -->
      <ng-template #revCardHeaderTitle>
        <nz-space>
          <nz-space-item>
            <i nz-icon
              nzType="civic:revision"></i> RID{{ revision.id }}
            <span>{{ revision.linkoutData.name }} Updated</span>
          </nz-space-item>
          <nz-space-item>
            <i nz-popover [nzPopoverContent]="revision.comments[0].comment" *ngIf="revision.comments.length > 0" nz-icon nzType="comment" nzTheme="outline"></i>
          </nz-space-item>
        </nz-space>
      </ng-template>

      <!-- header secondary & status -->
      <ng-template #revCardHeaderExtra>
        <nz-space nzSize="small" (click)="$event.stopPropagation()">
          <nz-space-item>
            <span nz-typography nzType="secondary">Submitted By</span>
            <cvc-user-tag [user]="revision.revisor"></cvc-user-tag>
            <span nz-typography nzType="secondary">{{ revision.createdAt | timeago }}</span>
          </nz-space-item>
          <nz-space-item>
            <cvc-status-tag [status]="revision.status"></cvc-status-tag>
          </nz-space-item>
          <nz-space-item>
            <nz-divider nzType="vertical"></nz-divider>
          </nz-space-item>
          <nz-space-item>
              <a nz-button nzType="link" (click)="onChangesetSelected(revision.revisionsetId)">Show Group</a> 
          </nz-space-item>
          <ng-container *ngIf="revision.status === 'NEW'">
            <nz-space-item>
              <nz-divider nzType="vertical"></nz-divider>
            </nz-space-item>
            <nz-space-item>
              <label nz-checkbox nz-tooltip nzTooltipTitle="Select Revision for Acceptance/Rejection" (nzCheckedChange)="onRevisionCheckboxClicked($event, revision.id)"></label>
            </nz-space-item>
          </ng-container>
        </nz-space>
      </ng-template>
    </nz-collapse-panel>
  </nz-collapse>
  <ng-template #noRevisions>
    <nz-empty nzNotFoundImage="simple" nzNotFoundContent="No Revisions matching filters"></nz-empty>
  </ng-template>
</nz-card>
<ng-template #moderationButtons>
  <ng-container *ngrxLet="validationErrors$ as validationErrors">
  <div nz-row
    style="margin-top: 1em;">
    <div nz-col
      nzSpan="24"
      style="text-align: right;">
      <nz-space nzDirection="horizontal">
        <nz-space-item>
          <button
            nz-button
            nz-popover
            nzSize="small"
            [nzPopoverTitle]="validationPopoverTitleTemplate"
            [(nzPopoverVisible)]="validationPopoverVisible"
            (click)="this.validationPopoverVisible = !this.validationPopoverVisible"
            [nzPopoverContent]="validationPopoverContentTemplate"
            [nzPopoverTrigger]="undefined "
            nzPopoverPlacement="bottom"
            [disabled]="this.selectedRevisionIds.length === 0"
          >
            Review Selected Revisions
            <i nz-icon nzType="caret-down" nzTheme="outline"></i>
          </button>
        </nz-space-item>
          <nz-space-item>
              <i nz-icon *ngIf="validationErrors.length > 0" nzType="question-circle" nzTheme="outline"
                nz-popover nzPopoverTitle="Selected Revisions would result in an invalid entity" [nzPopoverContent]="validationErrorTemplate"  
              ></i>
              <ng-template #validationErrorTemplate>
                <nz-list nzBordered nzSize="small">
                  <nz-list-item *ngFor="let error of validationErrors">{{ error }}</nz-list-item>
                </nz-list>
              </ng-template>
          </nz-space-item>
      </nz-space> 
      <ng-template #validationPopoverTitleTemplate>
        Review Selected Revisions
        <span [ngStyle]="{ 'float': 'right' }">
          <i nz-icon nzType="close" nzTheme="outline" (click)="this.validationPopoverVisible = false"></i>
        </span>
      </ng-template>
      <ng-template #validationPopoverContentTemplate>
        <nz-space nzDirection="vertical">
          <nz-space-item>
            <textarea rows="4" nz-input [(ngModel)]="revisionComment" placeholder="Additional comments (required if rejecting, minimum 10 characters)"></textarea>
          </nz-space-item>
          <nz-space-item>
            <nz-space>
              <nz-space-item>
                <cvc-org-selector-btn-group [(selectedOrg)]="this.mostRecentOrg">
                  <button type="submit"
                    nz-button
                    [nzLoading]="isLoading"
                    cvcOrgSelectorBtn
                    nzSize="small"
                    nzDanger
                    [disabled]="this.revisionComment === undefined || this.revisionComment.length < 10"
                    (click)="onRejectRevisionsClicked()"
                    >
                    Reject Revision
                  </button>
                </cvc-org-selector-btn-group>
              </nz-space-item>
              <nz-space-item>
                <cvc-org-selector-btn-group [(selectedOrg)]="this.mostRecentOrg">
                  <button type="submit"
                    nz-button
                    [nzLoading]="isLoading"
                    cvcOrgSelectorBtn
                    nzSize="small"
                    [disabled]="!(validationErrors.length == 0 && (this.revisionComment === undefined || this.revisionComment === '' || this.revisionComment.length >= 10))"
                    (click)="onAcceptRevisionClicked()"
                    >
                    Accept Revision
                  </button>
                </cvc-org-selector-btn-group>
              </nz-space-item>
              <nz-space-item>
                  <i nz-icon *ngIf="validationErrors.length > 0" nzType="question-circle" nzTheme="outline"
                    nz-popover nzPopoverTitle="Selected Revisions would result in an invalid entity" [nzPopoverContent]="validationErrorTemplate"  
                  ></i>
                  <ng-template #validationErrorTemplate>
                    <nz-list nzBordered nzSize="small">
                      <nz-list-item *ngFor="let error of validationErrors">{{ error }}</nz-list-item>
                    </nz-list>
                  </ng-template>
              </nz-space-item>
            </nz-space>
          </nz-space-item>
        </nz-space>
      </ng-template>
    </div>
  </div>
  </ng-container>
  </ng-template>
